---
- name: Controllare se il dialogo "{{ dialog_item.label }}" esiste
  uri:
    url: "https://{{ ip_address_appliance }}/api/service_dialogs?expand=resources&filter[]=label='{{ dialog_item.label | urlencode }}'"
    method: GET
    user: "{{ manageiq_user }}"
    password: "{{ manageiq_password }}"
    force_basic_auth: yes
    validate_certs: false
    return_content: yes
  register: dialog_check

- name: Creare il dialogo "{{ dialog_item.label }}" se non esiste
  uri:
    url: "https://{{ ip_address_appliance }}/api/service_dialogs"
    method: POST
    user: "{{ manageiq_user }}"
    password: "{{ manageiq_password }}"
    force_basic_auth: yes
    validate_certs: false
    headers:
      Content-Type: application/json
    body_format: json
    body:
      description: "{{ dialog_item.description }}"
      label: "{{ dialog_item.label }}"
      dialog_tabs: "{{ dialog_item.dialog_tabs }}"
    status_code: [200, 201]
  when: dialog_check.json.resources | length == 0
  register: create_dialog

# --- INIZIO BLOCCO MODIFICATO ---
- name: Aggiornare il dialogo "{{ dialog_item.label }}" se esiste giÃ 
  uri:
    url: "https://{{ ip_address_appliance }}/api/service_dialogs/{{ dialog_check.json.resources[0].id }}"
    # 1. MODIFICA: Il metodo deve essere POST, non PUT
    method: POST 
    user: "{{ manageiq_user }}"
    password: "{{ manageiq_password }}"
    force_basic_auth: yes
    validate_certs: false
    headers:
      Content-Type: application/json
    body_format: json
    # 2. MODIFICA: Il body deve essere wrappato in "action: edit" e "resource: ..."
    body:
      action: "edit"
      resource:
        description: "{{ dialog_item.description }}"
        label: "{{ dialog_item.label }}"
        dialog_tabs: "{{ dialog_item.dialog_tabs }}"
    status_code: [200, 201]
  when: dialog_check.json.resources | length > 0
  register: update_dialog
# --- FINE BLOCCO MODIFICATO ---

- name: Determinare l'ID del dialogo (Esistente o Aggiornato)
  set_fact:
    current_dialog_id: "{{ dialog_check.json.resources[0].id }}"
  when: dialog_check.json.resources | length > 0

- name: Determinare l'ID del dialogo (Nuovo)
  set_fact:
    current_dialog_id: "{{ create_dialog.json.results[0].id }}"
  when: create_dialog is defined and create_dialog.changed

- name: Aggiungere l'ID del dialogo al dizionario
  set_fact:
    dialog_ids_map: "{{ dialog_ids_map | combine({ dialog_item.name: current_dialog_id }) }}"

- name: Assert che il dialogo sia stato gestito correttamente e che l'ID sia stato salvato
  assert:
    that:
      - current_dialog_id is defined
    fail_msg: "Fallimento nel recuperare l'ID per il dialogo '{{ dialog_item.name }}'."
    success_msg: "ID del dialogo '{{ dialog_item.name }}' salvato: {{ current_dialog_id }}"
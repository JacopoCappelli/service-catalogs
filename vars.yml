---
# playbook/vars.yml

# Dettagli di connessione per ManageIQ
manageiq_host: "manageiq"
#manageiq_port: "3443"
manageiq_user: "admin"
manageiq_password: "smartvm"
ip_address_appliance: 172.16.0.174
collections:
   - manageiq.automate
# Dettagli del provider
provider_name: "DevStack"
provider_type: "ManageIQ::Providers::Openstack::CloudManager"
remove_existing: false

# Sezione per la definizione dei service catalogs
catalogs_to_create:
  - name: "IaaS"
    description: "Catalogo per servizi di Infrastructure as a Service"
  - name: "Altri Servizi"
    description: "Catalogo dei vari servizi"
  - name: "Servizi extra"
    description: "Catalogo per servizi aggiuntivi"


# --- NUOVA SEZIONE: Definizione dei Dialoghi di Servizio ---
service_dialogs_to_create:
  - name: "BlockStorageDialog"
    description: "Richiede i parametri per un nuovo Block Storage"
    label: "Crea Block Storage"
    dialog_tabs:
      - label: "Informazioni di base"
        position: 0
        dialog_groups:
          - label: "Dettagli Volume"
            position: 0
            dialog_fields:
              - name: "volume_name"
                label: "Nome Volume"
                type: "DialogFieldTextBox"
                required: true
                position: 0

              - name: "volume_description"
                label: "Descrizione"
                type: "DialogFieldTextBox"
                required: false
                position: 1

              - name: "volume_size"
                label: "Dimensione (GB)"
                type: "DialogFieldTextBox"
                data_type: "integer"
                required: true
                default_value: "10"
                position: 2

              - name: "cloud_tenant"
                label: "Cloud Tenant"
                type: "DialogFieldDropDownList"   
                default_value: "tenant"
                required: true
                position: 3
                values:
                  - ["tenant-1", "Tenant Produzione"]
                  - ["tenant-2", "Tenant Sviluppo"]

              - name: "volume_availability"
                label: "Zona Disponibile"
                type: "DialogFieldDropDownList"   
                data_type: "string"              
                required: true
                default_value: "nova"            
                position: 4
                values:
                  - ["nova", "Nova (default)"]
                  - ["zone-1", "Zona 1"]
                  - ["zone-2", "Zona 2"]

              - name: "volume_cloud_kind"
                label: "Tipo di volume Cloud"
                type: "DialogFieldDropDownList"   
                data_type: "string"              
                required: true
                default_value: "default"            
                position: 5
                values:
                  - ["tipo-1"]
                  - ["tipo-2"]

            

 


  - name: "CreateVMDialog"
    description: "Richiede i parametri per una nuova VM OpenStack"
    label: "Crea Virtual Machine"
    dialog_tabs:
      - label: "Configura la VM"
        position: 0
        dialog_groups:
          - label: "Autenticazione"
            position: 0
            dialog_fields:
             - name: "user_name"
               label: "Nome Utente"
               type: "DialogFieldTextBox"
               required: true
               position: 0 
         
             - name: "password"
               label: "Password"
               type: "DialogFieldTextBox"
               required: true
               position: 1

          - label: "Identità"
            position: 1
            dialog_fields:
              - name: "vm_name"
                label: "Nome VM"
                type: "DialogFieldTextBox"
                required: true
                position: 0

          - label: "Progetto"
            position: 2
            dialog_fields:
              - name: "project_field"
                label: "Tipo di Progetto"
                type: "DialogFieldDropDownList"
                position: 0

              - name: "project_availability"
                label: "Zona Disponibile"
                type: "DialogFieldDropDownList"
                position: 1
        
          - label: "Immagine e dimensione"
            position: 3
            dialog_fields:
              - name: "image"
                label: "Immagine"
                type: "DialogFieldDropDownList"
                position: 0
                values:
                 - ["1","Centos-Stream-10"]
                 - ["2",Rocky-10"]
                 - ["3","debian-10"]
                 - ["4","ubuntu 24.04"]
                 - ["5","windows2012"]


              - name: "flavors"
                label: "Configurazioni"
                type: "DialogFieldDropDownList"
                position: 1
                values:
                 - ["1",Large - 4vCPU, 16GB RAM, 100GB vHD"]
                 - ["2",large-1 - 4vCPU, 16GB RAM, 100GB vHD"]
                 - ["3",large-2 - 8vCPU, 32GB RAM, 200GB vHD"]
                 - ["4",medium - 4vCPU, 4GB RAM, 20GB vHD"]
                 - ["5",medium-1 - 2vCPU, 8GB RAM, 60GB vHD"]
                 - ["6",medium-2 - 4vCPU, 8GB RAM, 80GB vHD"]
                 - ["7",small-1 - 1vCPU, 2GB RAM, 20GB vHD"]
                 - ["8",small-2 - 2vCPU, 4GB RAM, 40GB vHD"]
                 - ["9",xlarge-1 - 16vCPU, 64GB RAM, 400GB vHD"]
                 - ["10",xlarge-2 - 32vCPU, 128GB RAM, 800GB vHD"]
          
          - label: "Rete e Sicurezza"
            position: 4
            dialog_fields:
              
              - name: "network"
                label: "Rete"
                type: "DialogFieldDropDownList"
                position: 0 
                values:
                 - ["ext","external-vlan20"]

              - name: "subnet"
                label: "Sottorete"
                type: "DialogFieldDropDownList"
                position: 1
                values:
                 - ["ext_sub","external-subnet20 - 5.9.220.160/27"]

              - name: "security_groups"
                label: "Gruppi di Sicurezza"
                type: "DialogFieldDropDownList"
                position: 2
                

              - name: "public_key"
                label: "Chiave pubblica (SSH)"
                type: "DialogFieldTextBox"
                position: 3

          - label: "Personalizzazione"
            position: 5
            dialog_fields:
              - name: "root_password"
                label: "Password di root" 
                type: "DialogFieldTextBox"  
                position: 0    


  - name: "Nginx_Service_Dialog"
    description: "Richiede i parametri per un Server Nginx"
    label: "Crea Server Nginx" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione Web Server"
            position: 0
            dialog_fields:
              - name: "fqdn"
                label: "FQDN"
                type: "DialogFieldTextBox"
                required: true
                position: 0
              - name: "tls_ssl"
                label: "TLS/SSL?"
                type: "DialogFieldCheckBox"
                default_value: true 
                position: 1
              - name: "web_root_dir"
                label: "Web root Directory"
                type: "DialogFieldTextBox"
                required: false 
                position: 2

  - name: "GitLab_Service_Dialog"
    description: "Richiede i parametri per un Server GitLab"
    label: "Crea Server GitLab" 
    dialog_tabs:
      - label: "Input" 
        position: 0
        dialog_groups:
          - label: "Configurazione GitLab" 
            position: 0
            dialog_fields:
              - name: "gitlab_root_password"
                label: "GitLab root Password"
                type: "DialogFieldTextBox"
                options: {protected: true} 
                required: true
                position: 0
              - name: "fqdn"
                label: "FQDN"
                type: "DialogFieldTextBox"
                required: true
                position: 1
              - name: "smtp_server"
                label: "SMTP Server"
                type: "DialogFieldTextBox"
                required: true
                position: 2
              - name: "smtp_port"
                label: "SMTP Port"
                type: "DialogFieldTextBox"
                data_type: "integer"
                default_value: "0"
                required: false
                position: 3
              - name: "smtp_username"
                label: "SMTP Username"
                type: "DialogFieldTextBox"
                required: true
                position: 4
              - name: "smtp_password"
                label: "SMTP Password"
                type: "DialogFieldTextBox"
                options: {protected: true} 
                required: true
                position: 5
              - name: "tls_ssl"
                label: "TLS/SSL?"
                type: "DialogFieldCheckBox"
                default_value: false
                position: 6

  - name: "Jenkins_Service_Dialog"
    description: "Richiede i parametri per un Server Jenkins"
    label: "Crea Server Jenkins" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione Jenkins"
            position: 0
            dialog_fields:
              - name: "jenkins_admin_username"
                label: "Jenkins admin Username"
                type: "DialogFieldTextBox"
                required: true
                position: 0
              - name: "jenkins_admin_password"
                label: "Jenkins admin Password"
                type: "DialogFieldTextBox"
                options: {protected: true} 
                required: true
                position: 1
              - name: "initial_plugin_list"
                label: "Initial Plugin List"
                type: "DialogFieldTextAreaBox" 
                required: false
                position: 2
              - name: "git_repo_url"
                label: "Git Repository URL"
                type: "DialogFieldTextBox"
                required: false
                position: 3

  - name: "MinIO_Service_Dialog"
    description: "Richiede i parametri per un Server MinIO"
    label: "Crea Server MinIO" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione MinIO"
            position: 0
            dialog_fields:
              - name: "minio_root_user"
                label: "MinIO root user"
                type: "DialogFieldTextBox"
                required: true
                position: 0
              - name: "minio_root_password"
                label: "MinIO root password"
                type: "DialogFieldTextBox"
                options: {protected: true} 
                required: true
                position: 1
              - name: "minio_secret_key"
                label: "MinIO secret key"
                type: "DialogFieldTextAreaBox" 
                options: {protected: true}
                required: true
                position: 2
              - name: "bucket_name"
                label: "Bucket name"
                type: "DialogFieldTextBox"
                required: false
                position: 3

  - name: "MySQL_Service_Dialog"
    description: "Richiede i parametri per un Server MySQL"
    label: "Crea Server MySQL" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione MySQL"
            position: 0
            dialog_fields:
              - name: "mysql_root_password"
                label: "MySQL root Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 0
              - name: "db_name"
                label: "Database Name"
                type: "DialogFieldTextBox"
                required: true
                position: 1
              - name: "db_user"
                label: "Database User"
                type: "DialogFieldTextBox"
                required: false
                position: 2
              - name: "db_password"
                label: "Database Password"
                type: "DialogFieldTextBox"
                options: {protected: true} 
                required: false
                position: 3

  - name: "Nextcloud_Service_Dialog"
    description: "Richiede i parametri per un Server Nextcloud"
    label: "Crea Server Nextcloud" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione Nextcloud"
            position: 0
            dialog_fields:
              - name: "nextcloud_admin_username"
                label: "Nextcloud admin Username"
                type: "DialogFieldTextBox"
                required: true
                position: 0
              - name: "nextcloud_admin_password"
                label: "Nextcloud admin Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 1
              - name: "external_storage_config"
                label: "External Storage Config"
                type: "DialogFieldTextAreaBox" # Campo grande
                required: false
                position: 2

  - name: "PostgreSQL_Service_Dialog"
    description: "Richiede i parametri per un Server PostgreSQL"
    label: "Crea Server PostgreSQL" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione Database"
            position: 0
            dialog_fields:
              - name: "psql_superuser_password"
                label: "PostgreSQL Superuser Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 0
              - name: "db_name"
                label: "Database Name"
                type: "DialogFieldTextBox"
                required: true
                position: 1
              - name: "db_user"
                label: "Database User"
                type: "DialogFieldTextBox"
                required: true
                position: 2
              - name: "db_password"
                label: "Database Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 3

  - name: "Wordpress_Service_Dialog"
    description: "Richiede i parametri per un Server WordPress"
    label: "Crea Server WordPress" #
    dialog_tabs:
      - label: "Input"
        position: 0
        dialog_groups:
          - label: "Configurazione WordPress"
            position: 0
            dialog_fields:
              - name: "wp_admin_username"
                label: "WordPress admin Username"
                type: "DialogFieldTextBox"
                required: true
                position: 0
              - name: "wp_admin_password"
                label: "WordPress admin Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 1
              - name: "wp_site_title"
                label: "WordPress Site Title"
                type: "DialogFieldTextBox"
                required: true
                position: 2
              - name: "mysql_root_password"
                label: "MySQL root Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: true
                position: 3
              - name: "mysql_db_name"
                label: "MySQL Database Name"
                type: "DialogFieldTextBox"
                required: false
                position: 4
              - name: "mysql_db_user"
                label: "MySQL Database User"
                type: "DialogFieldTextBox"
                required: true
                position: 5
              - name: "mysql_db_password"
                label: "MySQL Database Password"
                type: "DialogFieldTextBox"
                options: {protected: true} # Password mascherata
                required: false
                position: 6

# --- Il resto del file è invariato ---

icons_to_upload: 
  - name: "Nginx_Icon"
    filename: "Nginx.png"
    local_path: "icons/Nginx.png"
  
  - name: "Nextcloud_Icon"
    filename: "Nextcloud.png"
    local_path: "icons/Nextcloud.png"
# --- NUOVA SEZIONE: Definizione dei Service Templates (Servizi) ---
service_templates_to_create:
  - name: "Block Storage"
    description: "Crea un Block Storage"
    prov_type: "generic" # Tipo Generico come da immagine
    catalog_name: "IaaS"
    dialog_name: "BlockStorageDialog"

  - name: "Crea una Virtual Machine"
    description: "Crea una Virtual Machine"
    prov_type: "openstack" # Tipo OpenStack come da immagine
    catalog_name: "IaaS"
    dialog_name: "CreateVMDialog"

  - name: "Apache Web Server"
    description: "Apache Web Server"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "Nginx_Service_Dialog" # Nello screenshot usa questo dialog
    picture_name: "Nginx_Icon"

  - name: "Server GitLab"
    description: "Server GitLab"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "GitLab_Service_Dialog"

  - name: "Server Jenkins"
    description: "Server Jenkins"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "Jenkins_Service_Dialog"

  - name: "Server MinIO"
    description: "Server MinIO"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "MinIO_Service_Dialog"

  - name: "Server MySQL"
    description: "Server MySQL"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "MySQL_Service_Dialog"

  - name: "Server Nextcloud"
    description: "Server Nextcloud"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "Nextcloud_Service_Dialog"
    picture_name: "Nextcloud_Icon"

  - name: "Server Nginx"
    description: "Server Nginx"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "Nginx_Service_Dialog"

  - name: "Server PostgreSQL"
    description: "Server PostgreSQL"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "PostgreSQL_Service_Dialog"

  - name: "Server WordPress"
    description: "Server WordPress"
    prov_type: "generic"
    catalog_name: "Altri Servizi"
    dialog_name: "Wordpress_Service_Dialog"

  - name: Crea macchina virtuale su OpenStack con utente personalizzato
    openstack.cloud.server:
      name: "{{ vm_name }}"
      image: "{{ image }}"
      flavor: "{{ flavors }}"
      network: "{{ network }}"
      security_groups: "{{ security_groups | default(['default']) }}"
      key_name: "{{ public_key | default(omit) }}"
      userdata: |
        #cloud-config
        users:
          - name: "{{ user_name }}"
            groups: sudo
            shell: /bin/bash
            sudo: ["ALL=(ALL) NOPASSWD:ALL"]
            lock_passwd: false
            passwd: "{{ password | password_hash('sha512') }}"
        chpasswd:
          expire: false
        # Opzionale: imposta la password di root
        {% if root_password is defined and root_password | length > 0 %}
        system_info:
          default_user:
            name: root
            passwd: "{{ root_password | password_hash('sha512') }}"
        {% endif %}
      state: present
      wait: true
    no_log: true 